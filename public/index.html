<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sub2tenant · Tenant lookup</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">
        <span class="brand-title">sub2tenant</span>
        <span class="brand-subtitle">Tenant lookup</span>
      </div>

      <button id="me" class="chip" type="button">
        <span class="chip-label">Sign in</span>
      </button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Find tenant by Subscription ID</h1>
      <p class="lead">
        Enter an <strong>Azure subscription ID</strong>. The tool looks up
        <code>tenantId</code>, <code>displayName</code> and
        <code>defaultDomainName</code> using Azure Resource Manager and
        Microsoft Graph.
      </p>

      <form id="lookup-form" class="form">
        <label class="field">
          <span class="field-label">Subscription ID</span>
          <input
            id="subscriptionId"
            name="subscriptionId"
            class="input"
            type="text"
            placeholder="00000000-0000-0000-0000-000000000000"
            autocomplete="off"
            spellcheck="false"
          />
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Lookup</button>
          <button type="button" id="clear-btn" class="btn btn-ghost">Clear</button>
        </div>
      </form>

      <div id="status" class="status" aria-live="polite"></div>

      <dl class="result">
        <div class="result-row">
          <dt>Tenant ID</dt>
          <dd id="tenantId" class="mono muted">–</dd>
        </div>
        <div class="result-row">
          <dt>Display name</dt>
          <dd id="displayName" class="muted">–</dd>
        </div>
        <div class="result-row">
          <dt>Default domain</dt>
          <dd id="defaultDomain" class="mono muted">–</dd>
        </div>
      </dl>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <span>© 2025 sub2tenant.com</span>
    </div>
  </footer>

  <script>
    const meButton = document.getElementById("me");
    const meLabel = meButton.querySelector(".chip-label");
    const form = document.getElementById("lookup-form");
    const subscriptionInput = document.getElementById("subscriptionId");
    const statusEl = document.getElementById("status");
    const clearBtn = document.getElementById("clear-btn");

    const tenantIdEl = document.getElementById("tenantId");
    const displayNameEl = document.getElementById("displayName");
    const defaultDomainEl = document.getElementById("defaultDomain");

    let currentUser = null;

    function setStatus(message, type = "info") {
      statusEl.textContent = message || "";
      statusEl.className = "status " + (message ? "status-" + type : "");
    }

    function setResults({ tenantId, displayName, defaultDomain } = {}) {
      tenantIdEl.textContent = tenantId || "–";
      displayNameEl.textContent = displayName || "–";
      defaultDomainEl.textContent = defaultDomain || "–";

      tenantIdEl.classList.toggle("muted", !tenantId);
      displayNameEl.classList.toggle("muted", !displayName);
      defaultDomainEl.classList.toggle("muted", !defaultDomain);
    }

    async function fetchMe() {
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        if (!res.ok) {
          currentUser = null;
          meLabel.textContent = "Sign in";
          meButton.classList.remove("chip-authenticated");
          return;
        }
        const data = await res.json();
        currentUser = data;
        meLabel.textContent = data.userPrincipalName || data.name || "Signed in";
        meButton.classList.add("chip-authenticated");
      } catch {
        currentUser = null;
        meLabel.textContent = "Sign in";
        meButton.classList.remove("chip-authenticated");
      }
    }

    meButton.addEventListener("click", () => {
      if (!currentUser) {
        window.location.href = "/.auth/login/aad?post_login_redirect_uri=/";
      } else {
        const url = "/.auth/logout?post_logout_redirect_uri=/";
        window.location.href = url;
      }
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const subscriptionId = subscriptionInput.value.trim();

      if (!subscriptionId) {
        setStatus("Please enter a subscription ID.", "error");
        return;
      }

      setStatus("Looking up subscription…", "info");
      setResults();

      try {
        const res = await fetch("/api/lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ subscriptionId })
        });

        if (!res.ok) {
          let message = "Lookup failed.";
          try {
            const err = await res.json();
            if (err?.error) message = err.error;
          } catch {}
          if (res.status === 401) message = "You must sign in to use the lookup.";
          throw new Error(message);
        }

        const data = await res.json();
        setResults(data);
        setStatus("Lookup completed.", "success");
      } catch (err) {
        setResults();
        setStatus(err.message || "Lookup failed.", "error");
      }
    });

    clearBtn.addEventListener("click", () => {
      subscriptionInput.value = "";
      setResults();
      setStatus("");
      subscriptionInput.focus();
    });

    fetchMe();
  </script>
</body>
</html>
