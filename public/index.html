<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sub2tenant · Tenant lookup</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="nav-left">sub2tenant.com</div>
      <div class="nav-center">Find tenant from subscription ID</div>
      <div class="nav-right"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-inner">
        <h2 class="card-title">Provide an Azure subscription ID</h2>

        <p class="lead">
          The tool resolves <code>tenantId</code>, <code>displayName</code> and
          <code>defaultDomainName</code> using the Azure Resource Manager
          <code>WWW-Authenticate</code> header and Microsoft Graph’s
          <code>findTenantInformationByTenantId</code> endpoint. 
        </p>

        <form id="lookup-form" class="form">
          <div class="form-row">
            <input
              id="subscriptionId"
              name="subscriptionId"
              class="input"
              type="text"
              placeholder="00000000-0000-0000-0000-000000000000"
              autocomplete="off"
              spellcheck="false"
              aria-label="Subscription ID"
            />

            <button type="submit" class="btn btn-primary btn-sm" id="lookup-btn">
              Lookup
            </button>

            <button
              type="button"
              id="clear-btn"
              class="btn btn-ghost btn-xs form-clear"
            >
              Clear
            </button>
          </div>
        </form>

        <div id="status" class="status" aria-live="polite"></div>

        <div id="results-container" class="results-hidden">
          <dl class="result" aria-label="Lookup result">
            <div class="result-row">
              <dt>Tenant ID</dt>
              <dd class="result-value">
                <span id="tenantId" class="mono muted">–</span>
                <button
                  type="button"
                  class="btn-icon copy-btn"
                  data-copy-target="tenantId"
                >
                  Copy
                </button>
              </dd>
            </div>

            <div class="result-row">
              <dt>Display name</dt>
              <dd class="result-value">
                <span id="displayName" class="muted">–</span>
                <button
                  type="button"
                  class="btn-icon copy-btn"
                  data-copy-target="displayName"
                >
                  Copy
                </button>
              </dd>
            </div>

            <div class="result-row">
              <dt>Default domain</dt>
              <dd class="result-value">
                <span id="defaultDomain" class="mono muted">–</span>
                <button
                  type="button"
                  class="btn-icon copy-btn"
                  data-copy-target="defaultDomain"
                >
                  Copy
                </button>
              </dd>
            </div>
          </dl>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <span>© 2025 sub2tenant.com · Lookups are not logged or stored.</span>
    </div>
  </footer>

  <script>
    const form = document.getElementById("lookup-form");
    const subscriptionInput = document.getElementById("subscriptionId");
    const statusEl = document.getElementById("status");
    const clearBtn = document.getElementById("clear-btn");
    const lookupBtn = document.getElementById("lookup-btn");
    const resultsContainer = document.getElementById("results-container");

    const tenantIdEl = document.getElementById("tenantId");
    const displayNameEl = document.getElementById("displayName");
    const defaultDomainEl = document.getElementById("defaultDomain");
    const copyButtons = document.querySelectorAll(".copy-btn");

    function setStatus(message, type = "info") {
      statusEl.textContent = message || "";
      statusEl.className = "status" + (message ? " status-" + type : "");
    }

    function setResults({ tenantId, displayName, defaultDomain } = {}) {
      tenantIdEl.textContent = tenantId || "–";
      displayNameEl.textContent = displayName || "–";
      defaultDomainEl.textContent = defaultDomain || "–";

      tenantIdEl.classList.toggle("muted", !tenantId);
      displayNameEl.classList.toggle("muted", !displayName);
      defaultDomainEl.classList.toggle("muted", !defaultDomain);
    }

    function setLoading(isLoading) {
      lookupBtn.disabled = isLoading;
      lookupBtn.textContent = isLoading ? "Looking up…" : "Lookup";
    }

    function showResults() {
      resultsContainer.classList.remove("results-hidden");
      resultsContainer.classList.add("results-visible");
    }

    function hideResults() {
      resultsContainer.classList.add("results-hidden");
      resultsContainer.classList.remove("results-visible");
    }

    // Copy buttons
    copyButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const targetId = btn.getAttribute("data-copy-target");
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;

        const value = (targetEl.textContent || "").trim();
        if (!value || value === "–") return;

        try {
          await navigator.clipboard.writeText(value);
          const original = btn.textContent;
          btn.classList.add("copy-btn-copied");
          btn.textContent = "Copied";
          setTimeout(() => {
            btn.classList.remove("copy-btn-copied");
            btn.textContent = original;
          }, 1100);
        } catch {
          setStatus("Could not copy to clipboard.", "error");
        }
      });
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const subscriptionId = subscriptionInput.value.trim();

      if (!subscriptionId) {
        setStatus("Please enter a subscription ID.", "error");
        hideResults();
        return;
      }

      const guidLike = /^[0-9a-fA-F-]{30,}$/;
      if (!guidLike.test(subscriptionId)) {
        setStatus("That does not look like a valid subscription ID.", "error");
        hideResults();
        return;
      }

      setStatus("Looking up subscription…", "info");
      setResults();
      setLoading(true);
      hideResults();

      try {
        const res = await fetch("/api/lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subscriptionId }),
        });

        if (!res.ok) {
          let message = "Lookup failed.";
          try {
            const err = await res.json();
            if (err?.error) message = err.error;
          } catch {}
          throw new Error(message);
        }

        const data = await res.json();
        setResults(data);
        setStatus("Lookup completed.", "success");
        showResults();
      } catch (err) {
        setResults();
        setStatus(err.message || "Lookup failed.", "error");
        hideResults();
      } finally {
        setLoading(false);
      }
    });

    clearBtn.addEventListener("click", () => {
      subscriptionInput.value = "";
      setResults();
      setStatus("");
      hideResults();
      subscriptionInput.focus();
    });

    // Initial empty state
    setResults();
    hideResults();
  </script>
</body>
</html>
